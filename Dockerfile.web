# DiliVet â€“ ML-DSA diagnostics and vetting toolkit
# Multi-stage Dockerfile for web UI (backend + frontend)

# Stage 1: Build frontend
FROM node:20-alpine AS frontend-builder

WORKDIR /build

# Copy frontend files
COPY web/ui/package*.json ./
RUN npm ci

COPY web/ui/ ./
RUN npm run build

# Stage 2: Build backend and combine
FROM golang:1.23-alpine AS backend-builder

WORKDIR /build

# Copy go mod files
COPY go.mod go.sum ./
RUN go mod download

# Copy source
COPY . .

# Build backend
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
    go build -trimpath -ldflags "-s -w" \
    -o /dilivet-web ./web/server

# Stage 3: Final image
FROM alpine:latest

RUN apk --no-cache add ca-certificates

WORKDIR /app

# Copy backend binary
COPY --from=backend-builder /dilivet-web /app/dilivet-web

# Copy frontend build
COPY --from=frontend-builder /build/dist /app/web/ui/dist

# Copy KAT vectors (needed for /api/kat-verify)
COPY code/clean/testdata/kats /app/code/clean/testdata/kats

EXPOSE 8080

ENV PORT=8080

CMD ["/app/dilivet-web"]

